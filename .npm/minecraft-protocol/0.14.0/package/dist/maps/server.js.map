{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["var net = require('net')\n  , EventEmitter = require('events').EventEmitter\n  , util = require('util')\n  , Client = require('./client')\n  , states = require('./transforms/serializer').states\n  ;\n\nmodule.exports = Server;\n\nfunction Server() {\n  EventEmitter.call(this);\n\n  this.socketServer = null;\n  this.cipher = null;\n  this.decipher = null;\n  this.clients = {};\n}\nutil.inherits(Server, EventEmitter);\n\nServer.prototype.listen = function(port, host) {\n  var self = this;\n  var nextId = 0;\n  self.socketServer = net.createServer();\n  self.socketServer.on('connection', function(socket) {\n    var client = new Client(true);\n    client._end = client.end;\n    client.end = function end(endReason) {\n      if(client.state === states.PLAY) {\n        client.write(0x40, {reason: endReason});\n      } else if(client.state === states.LOGIN) {\n        client.write(0x00, {reason: endReason});\n      }\n      client._end(endReason);\n    };\n    client.id = nextId++;\n    self.clients[client.id] = client;\n    client.on('error', function(err) {\n      self.emit('error', err);\n    });\n    client.on('end', function() {\n      delete self.clients[client.id];\n    });\n    client.setSocket(socket);\n    self.emit('connection', client);\n  });\n  self.socketServer.on('error', function(err) {\n    self.emit('error', err);\n  });\n  self.socketServer.on('close', function() {\n    self.emit('close');\n  });\n  self.socketServer.on('listening', function() {\n    self.emit('listening');\n  });\n  self.socketServer.listen(port, host);\n};\n\nServer.prototype.close = function() {\n  var client;\n  for(var clientId in this.clients) {\n    if(!this.clients.hasOwnProperty(clientId)) continue;\n\n    client = this.clients[clientId];\n    client.end('ServerShutdown');\n  }\n  this.socketServer.close();\n};\n"],"sourceRoot":"/source/"}